---
groups:
  - name: Node rules
    rules:
      - alert: NodeExporterDown
        expr: 'up{job="node-exporter"} == 0'
        for: 2m
        labels:
          severity: warning
        annotations:
          description: 'Prometheus cannot scrape {{ $labels.instance }} for more than 2 minutes.'
          summary: 'Job `node-exporter` target is down'
          node_stats_url: '{{ $externalLabels.grafana_url }}/d/rYdddlPWk/node-status?orgId=1&var-DS_PROMETHEUS=default&var-job=node-exporter&var-node={{ $labels.instance }}'
      - alert: RebootRequired
        expr: 'node_reboot_required > 0'
        labels:
          severity: warning
        annotations:
          description: '{{ $labels.instance }} requires a reboot.'
          summary: 'Instance {{ $labels.instance }} - reboot required'
      - alert: NodeFilesystemSpaceFillingUp
        expr: '(node_filesystem_avail_bytes{job="node",fstype!=""} / node_filesystem_size_bytes{job="node",fstype!=""} * 100 < 40 and predict_linear(node_filesystem_avail_bytes{job="node",fstype!=""}[6h], 24*60*60) < 0 and node_filesystem_readonly{job="node",fstype!=""} == 0)'
        for: 1h
        labels:
          severity: warning
        annotations:
          description: 'Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space left and is filling up.'
          summary: 'Filesystem is predicted to run out of space within the next 24 hours.'
      - alert: NodeFilesystemSpaceFillingUp
        expr: '(node_filesystem_avail_bytes{job="node",fstype!=""} / node_filesystem_size_bytes{job="node",fstype!=""} * 100 < 20 and predict_linear(node_filesystem_avail_bytes{job="node",fstype!=""}[6h], 4*60*60) < 0 and node_filesystem_readonly{job="node",fstype!=""} == 0)'
        for: 1h
        labels:
          severity: critical
        annotations:
          description: 'Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space left and is filling up fast.'
          summary: 'Filesystem is predicted to run out of space within the next 4 hours.'
      - alert: NodeFilesystemAlmostOutOfSpace
        expr: '(node_filesystem_avail_bytes{job="node",fstype!=""} / node_filesystem_size_bytes{job="node",fstype!=""} * 100 < 5 and node_filesystem_readonly{job="node",fstype!=""} == 0)'
        for: 1h
        labels:
          severity: warning
        annotations:
          description: 'Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space left.'
          summary: 'Filesystem has less than 5% space left.'
      - alert: NodeFilesystemAlmostOutOfSpace
        expr: '(node_filesystem_avail_bytes{job="node",fstype!=""} / node_filesystem_size_bytes{job="node",fstype!=""} * 100 < 3 and node_filesystem_readonly{job="node",fstype!=""} == 0)'
        for: 1h
        labels:
          severity: critical
        annotations:
          description: 'Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space left.'
          summary: 'Filesystem has less than 3% space left.'
      - alert: NodeFilesystemFilesFillingUp
        expr: '(node_filesystem_files_free{job="node",fstype!=""} / node_filesystem_files{job="node",fstype!=""} * 100 < 40 and predict_linear(node_filesystem_files_free{job="node",fstype!=""}[6h], 24*60*60) < 0 and node_filesystem_readonly{job="node",fstype!=""} == 0)'
        for: 1h
        labels:
          severity: warning
        annotations:
          description: 'Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available inodes left and is filling up.'
          summary: 'Filesystem is predicted to run out of inodes within the next 24 hours.'
      - alert: NodeFilesystemFilesFillingUp
        expr: '(node_filesystem_files_free{job="node",fstype!=""} / node_filesystem_files{job="node",fstype!=""} * 100 < 20 and  predict_linear(node_filesystem_files_free{job="node",fstype!=""}[6h], 4*60*60) < 0 and  node_filesystem_readonly{job="node",fstype!=""} == 0)'
        for: 1h
        labels:
          severity: critical
        annotations:
          description: 'Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available inodes left and is filling up fast.'
          summary: 'Filesystem is predicted to run out of inodes within the next 4 hours.'
      - alert: NodeFilesystemAlmostOutOfFiles
        expr: '(node_filesystem_files_free{job="node",fstype!=""} / node_filesystem_files{job="node",fstype!=""} * 100 < 5 and node_filesystem_readonly{job="node",fstype!=""} == 0)'
        for: 1h
        labels:
          severity: warning
        annotations:
          description: 'Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available inodes left.'
          summary: 'Filesystem has less than 5% inodes left.'
      - alert: NodeFilesystemAlmostOutOfFiles
        expr: '(node_filesystem_files_free{job="node",fstype!=""} / node_filesystem_files{job="node",fstype!=""} * 100 < 3 and node_filesystem_readonly{job="node",fstype!=""} == 0)'
        for: 1h
        labels:
          severity: critical
        annotations:
          description: 'Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available inodes left.'
          summary: 'Filesystem has less than 3% inodes left.'
      - alert: NodeNetworkReceiveErrs
        expr: 'increase(node_network_receive_errs_total[2m]) > 10'
        for: 1h
        labels:
          severity: warning
        annotations:
          description: '{{ $labels.instance }} interface {{ $labels.device }} has encountered {{ printf "%.0f" $value }} receive errors in the last two minutes.'
          summary: 'Network interface is reporting many receive errors.'
      - alert: NodeNetworkTransmitErrs
        expr: "increase(node_network_transmit_errs_total[2m]) > 10"
        for: 1h
        labels:
          severity: warning
        annotations:
          description: '{{ $labels.instance }} interface {{ $labels.device }} has encountered {{ printf "%.0f" $value }} transmit errors in the last two minutes.'
          summary: 'Network interface is reporting many transmit errors.'
      - alert: NodeHighNumberConntrackEntriesUsed
        expr: "(node_nf_conntrack_entries / node_nf_conntrack_entries_limit) > 0.75"
        labels:
          severity: warning
        annotations:
          description: '{{ $value | humanizePercentage }} of conntrack entries on {{ $labels.instance }} are used.'
          summary: 'Number of conntrack are getting close to the limit'
      - alert: NodeClockSkewDetected
        expr: "(node_timex_offset_seconds > 0.05 and deriv(node_timex_offset_seconds[5m]) >= 0) or (node_timex_offset_seconds < -0.05 and deriv(node_timex_offset_seconds[5m]) <= 0)"
        for: 10m
        labels:
          severity: warning
        annotations:
          message: 'Clock on {{ $labels.instance }} is out of sync by more than 300s. Ensure NTP is configured correctly on this host.'
          summary: 'Clock skew detected.'
      - alert: NodeClockNotSynchronising
        expr: "min_over_time(node_timex_sync_status[5m]) == 0"
        for: 10m
        labels:
          severity: warning
        annotations:
          message: 'Clock on {{ $labels.instance }} is not synchronising. Ensure NTP is configured on this host.'
          summary: 'Clock not synchronising.'