{% for host in (groups['node_exporter_targets'] + groups['network_devices'] %}
- targets:
{% if 'ansible_host' in hostvars[host] and hostvars[host]['ansible_host'] | ipaddr %}
    - {{ hostvars[host]['ansible_host'] }}
{% elif 'ansible_fqdn' in hostvars[host] %}
    - {{ lookup('dig', hostvars[host]['ansible_fqdn']) | first }}
{% endif %}
  labels:
    instance: {{ host }}
{% if 'site' in hostvars[host] %}
    location: {{ hostvars[host]['site'] }}
{% else %}
    location: moonstone
{% endif %}
    environment: production
{% endfor %}
